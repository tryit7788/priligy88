---
import ProductLayouts from "@/layouts/functional-components/product/ProductLayouts";
import ProductFilters from "@/layouts/functional-components/ProductFilters";
import ProductLayoutViews from "@/layouts/functional-components/ProductLayoutViews";
import Base from "@/layouts/Base.astro";
import config from "@/config/config.json";
import Pagination from "@/layouts/components/Pagination.astro";
import {
  getCollections,
  getHighestProductPrice,
  getProducts,
  getVendors,
  getTags,
  type PageInfo,
  getAllProducts,
} from "@/lib/payload/products";
import CallToAction from "@/partials/CallToAction.astro";
import type { Brand, Product, ProductCategory, ProductTag } from "payload_app";
import { sorting, defaultSort } from "@/lib/constants";

export const prerender = false;

export async function getStaticPaths() {
  try {
    const { getProducts } = await import("@/lib/payload/products");
    const result = await getProducts({ cursor: "1" });
    const maxPages = result.totalPages;

    const paths = [];

    for (let page = 2; page <= maxPages; page++) {
      paths.push({
        params: { page: page.toString() },
      });
    }

    return paths;
  } catch (error) {
    console.error("Error generating static paths for product pages:", error);
    return [];
  }
}

const { page } = Astro.params;
const currentPage = parseInt(page || "1");

const searchParams = Astro.url.searchParams;
const sortSlug = searchParams.get("sort") || "";
const sortOption = sorting.find((s) => s.slug === sortSlug) || defaultSort;
const searchQuery = searchParams.get("q") || "";
const brands = searchParams.getAll("b");
const category = searchParams.get("c") || "";
const tag = searchParams.get("t") || "";
const minPrice = parseFloat(searchParams.get("minPrice") || "0");
const maxPrice = parseFloat(searchParams.get("maxPrice") || "999999");

const query: any = {};
if (brands.length > 0) {
  query.brands = brands;
}
if (category) {
  query.categories = [category];
}
if (tag) {
  query.tags = [tag];
}
if (minPrice > 0 || maxPrice < 999999) {
  query.price = { min: minPrice, max: maxPrice };
}
if (searchQuery) {
  query.search = searchQuery;
}

const [
  productsResult,
  allCategories,
  allVendors,
  allTags,
  highestPrice,
  allProducts,
] = await Promise.all([
  getProducts({
    cursor: currentPage.toString(),
    sortKey: sortOption.sortKey,
    reverse: sortOption.reverse,
    query: Object.keys(query).length > 0 ? query : undefined,
  }),
  getCollections(),
  getVendors(),
  getTags(),
  getHighestProductPrice(),
  getAllProducts(),
]);

const { products, pageInfo, totalPages } = productsResult;

const vendorsWithCounts = allVendors.map((vendor) => {
  const count = allProducts.filter(
    (p) => (p.brand as Brand)?.id === vendor.id,
  ).length;
  return { vendor: vendor.name, slug: vendor.slug, productCount: count };
});

const categoriesWithCounts = allCategories.map((category) => {
  const count = allProducts.filter(
    (p) => (p.category as ProductCategory)?.id === category.id,
  ).length;
  return { name: category.name, slug: category.slug, productCount: count };
});

const tags: ProductTag[] = allTags;

const maxPriceData = {
  amount: highestPrice.toString(),
  currencyCode: config.shopify.currencyCode,
};
---

<Base title={`Products - Page ${currentPage}`}>
  <ProductLayouts
    categories={categoriesWithCounts as any}
    vendors={vendorsWithCounts as any}
    tags={tags}
    maxPriceData={maxPriceData}
    client:only="react"
  />

  <div class="container">
    <div class="row">
      <div class="col-3 hidden lg:block -mt-14">
        <ProductFilters
          categories={categoriesWithCounts as any}
          vendors={vendorsWithCounts as any}
          tags={tags}
          maxPriceData={maxPriceData!}
          client:only="react"
        />
      </div>

      <ProductLayoutViews
        initialProducts={products}
        useClientSideFiltering={false}
        client:only="react"
      />

      {
        totalPages > 1 && (
          <div class="col-12 mt-8">
            <Pagination
              section="products"
              currentPage={currentPage}
              totalPages={totalPages}
            />
          </div>
        )
      }

      <CallToAction />
    </div>
  </div>
</Base>
